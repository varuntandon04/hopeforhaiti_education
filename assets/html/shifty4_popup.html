<!DOCTYPE html>
<html>
  <head>
    <title>Shifty4 Credit Card Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../css/shifty4_popup.css" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://js.dev.shift4.com/shift4.js" defer></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js" defer></script>

    <script>
      var totalValue = 0;
      var currency_symbol = "$";
      var currency = "USD";

      function getParameterValue(parameterName) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(parameterName);
      }

      function init() {
        // Get the total value from the URL parameter
        const total = getParameterValue("total");
        console.log("total = ", total);
        totalValue = Number(total.substring(1));
        currency_symbol = total.substring(0, 1);

        // Set the total value in the div
        var amountDiv = document.getElementById("amount");

        if (amountDiv) {
          amountDiv.innerHTML = total;
          $('#btnPay').removeAttr('disabled')
        } else {
          console.error("Element with ID 'amount' not found.");
        }
      }

      window.onload = init;
    </script>

    <script>
      function toastM() {
        var x = document.getElementById("toast");
        x.className = "show";
        setTimeout(function () {
          x.className = x.className.replace("show", "");
        }, 3000);
      }
      function validateForm() {
        startLoading();

        const BACKEND_API = "6a3abeb3-bde5-45bf-85ce-c6cadcbb67b8";
        const BACKEND_URL = "https://api.8base.com/clirdmoaa000d08l28ill17m9";
        const SHIFT4_PUBLIC_KEY = "pk_test_jcMLbiXi9FymReWolTm8pggJ";
        const SHIFT4_URL = "https://api.shift4.com/tokens";
        let bResult = false;

        const validAmount = validateAmount();
        const validCardNumber = validateCardNumber();
        const validCardholderName = validateCardholderName();
        const validExpiryDate = validateExpiryDate();
        const validCVV = validateCVV();

        if (validAmount && validCardNumber && validCardholderName && validExpiryDate && validCVV) {
          const cardNumber = document.getElementById("card-number").value.trim();
          const cardExpire = document.getElementById("expiry-date").value.trim();
          const expMonth = cardExpire.substring(0, cardExpire.indexOf("/"));
          const expYear = cardExpire.substring(cardExpire.indexOf("/") + 1);
          const cardCvc = document.getElementById("cvv").value.trim();
          const cardholderName = document.getElementById("cardholder-name").value.trim();

          axios
            .post(
              SHIFT4_URL,
              {
                number: cardNumber,
                expMonth: expMonth,
                expYear: expYear,
                cvc: cardCvc,
                cardholderName: cardholderName,
              },
              {
                headers: {
                  "Access-Control-Allow-Origin": "*",
                  "Content-Type": "application/json",
                },
                auth: {
                  username: SHIFT4_PUBLIC_KEY,
                  password: "",
                },
              }
            )
            .then((res) => res.data.id)
            .then((token) => {
              const url = BACKEND_URL + "/webhook/payment-shifty";

              axios
                .post(url, {
                  tokenId: token,
                  priceAmount: totalValue,
                })
                .then((res) => {
                  stopLoading();
                  bResult = res.data.result;
                  if (bResult) {
                    $('#btnPay').attr('disabled', 'true');
                    toastM();
                  }
                });
            })
            .catch((err) => {
              stopLoading();
              console.log(err);
            });
        }
        return bResult;
      }

      function setError(inputElement, message) {
        var errorElement = inputElement.parentElement.querySelector(".error-message");
        errorElement.innerText = message;
      }

      function clearError(inputElement) {
        var errorElement = inputElement.parentElement.querySelector(".error-message");
        errorElement.innerText = "";
      }

      function formatCardNumber(inputElement) {
        var cardNumber = inputElement.value;
        var formattedCardNumber = cardNumber.replace(/\s/g, ""); // Remove existing spaces
        var formattedValue = "";

        for (var i = 0; i < formattedCardNumber.length; i += 4) {
          formattedValue += formattedCardNumber.substr(i, 4) + " ";
        }

        inputElement.value = formattedValue.trim();
      }

      function isValidCardNumber(cardNumber) {
        var regex = /^(?:3[47]\d{13}|(?:4\d|5[1-5]|65)\d{14})$/;
        return regex.test(cardNumber);
      }

      function isValidExpiryDate(expiryDate) {
        var regex = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
        if (!regex.test(expiryDate)) return false;

        var parts = expiryDate.split("/");
        var month = parseInt(parts[0], 10);
        var year = parseInt(parts[1], 10);

        var currentDate = new Date();
        var currentYear = currentDate.getFullYear() % 100;
        var currentMonth = currentDate.getMonth() + 1;

        if (year < currentYear || (year === currentYear && month < currentMonth)) {
          return false;
        }

        return true;
      }

      function isValidCVV(cvv) {
        var regex = /^[0-9]{3,4}$/;
        return regex.test(cvv);
      }

      function validateCardNumber() {
        var cardNumberInput = document.getElementById("card-number");
        var cardNumber = cardNumberInput.value.trim();

        if (cardNumber === "") {
          setError(cardNumberInput, "Card number is required");
          return false;
        }

        var cleanedCardNumber = cardNumber.replace(/\D/g, "");

        if (!isValidCardNumber(cleanedCardNumber)) {
          setError(cardNumberInput, "Invalid card number");
          return false;
        }

        clearError(cardNumberInput);
        formatCardNumber(cardNumberInput); // Format the card number

        return true;
      }

      function validateAmount() {
        // var amountInput = document.getElementById("amount");
        // var amount = parseFloat(amountInput.value.trim());
        var amountInput = document.getElementById("amount");
        var amount = parseFloat(amountInput.textContent.trim());

        return true;
      }

      function validateCardholderName() {
        var cardholderNameInput = document.getElementById("cardholder-name");
        var cardholderName = cardholderNameInput.value.trim();

        if (cardholderName === "") {
          setError(cardholderNameInput, "Cardholder name is required");
          return false;
        }

        clearError(cardholderNameInput);
        return true;
      }

      function validateExpiryDate() {
        var expiryDateInput = document.getElementById("expiry-date");
        var expiryDate = expiryDateInput.value.trim();

        if (expiryDate === "") {
          setError(expiryDateInput, "Expiry date is required");
          return false;
        }

        if (!isValidExpiryDate(expiryDate)) {
          setError(expiryDateInput, "Invalid expiry date");
          return false;
        }

        clearError(expiryDateInput);
        return true;
      }

      function validateCVV() {
        var cvvInput = document.getElementById("cvv");
        var cvv = cvvInput.value.trim();

        if (cvv === "") {
          setError(cvvInput, "CVV is required");
          return false;
        }

        if (!isValidCVV(cvv)) {
          setError(cvvInput, "Invalid CVV");
          return false;
        }

        clearError(cvvInput);
        return true;
      }

      function closePopup() {
        window.parent.document.querySelector("#shopping_cart").remove();
      }

      function navigateShoppingCart() {
        window.location.href = "shopping_cart.html";
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div><input type="button" value="X" onclick="closePopup()" /></div>
      <h2>Shift4 Credit Card Information</h2>
      <form id="card-info">
        <div class="row">
          <label>Amount:</label>
          <div id="amount"></div>
          <!-- <input type="number" id="amount" name="amount"   min="0" step="0.01" required> -->
          <!-- <div class="error-message"></div> -->
        </div>
        <div class="form-group">
          <label for="card-number">Card Number:</label>
          <input type="text" value="4242 4242 4242 4242" id="card-number" name="card-number" placeholder="Enter card number" onblur="validateCardNumber()" required oninput="formatCardNumber(this)" />
          <div class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="cardholder-name">Cardholder Name:</label>
          <input type="text" value="Guo" id="cardholder-name" name="cardholder-name" placeholder="Enter cardholder name" onblur="validateCardholderName()" required />
          <div class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="expiry-date">Expiry Date:</label>
          <input type="text" value="04/24" id="expiry-date" name="expiry-date" placeholder="MM/YY" onblur="validateExpiryDate()" required />
          <div class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="cvv">CVV:</label>
          <input type="text" value="424" id="cvv" name="cvv" placeholder="Enter CVV" onblur="validateCVV()" required />
          <div class="error-message"></div>
        </div>
        <div class="form-group" style="display: flex">
          <div style="flex: 50%">
            <button onclick="navigateShoppingCart()">
              <i class="fas fa-arrow-left"> </i>
              Back
            </button>
          </div>
          <div class="form-group" style="float:right">
            <button id="btnPay" type="submit" onclick="validateForm()" disabled>
              <i class="fas fa-credit-card"> </i>
              Pay Now
            </button>
          </div>
        </div>
      </form>
      <div id="toast">Shift4 Charge Success!</div>
    </div>
    <div id="loader" style="pointer-events: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; backdrop-filter: blur(0.5rem); z-index: 9999999; display: none">
      <div
        style="
          background-image: url(../images/loading.gif);
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 100px;
          height: 100px;
          background-size: cover;
          background-position: center;
          border-radius: 1000vh;
          box-shadow: 0 0 10rem white;
        "
      ></div>
    </div>
    <script>
      $('#card-info').submit(e => {
        e.preventDefault()
      })
      function startLoading() {
        $(window.parent.document.body).css("pointer-events", "none");
        $("#loader").show();
      }
      function stopLoading() {
        $(window.parent.document.body).css("pointer-events", "unset");
        $("#loader").hide();
      }
      stopLoading();
    </script>
  </body>
</html>
